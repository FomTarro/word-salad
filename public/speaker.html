<!DOCTYPE html>
<html>
    <script>
        function speak(request) {
            const chunks = []
            const ready = [];
            for(const command of request.commands){
                // if it's a file
                if(command.path){
                    const clip = new Audio(`./banks/${request.bank}/?wordPath=${command.path}`);
                    clip.oncanplaythrough = () => {
                        ready.push(true);
                        if(ready.length == chunks.length){
                            chunks[0].play();
                        }
                    }
                    chunks.push({
                        onended(){ 
                            console.warn("OnEnded Callback not initialized.")
                        },
                        play(){
                            clip.onended = this.onended;
                            clip.play();
                        }   
                    });
                // else, it's punctuation
                }else{
                    ready.push(true);
                    chunks.push({
                        onended(){ 
                            console.warn("OnEnded Callback not initialized.")
                        },
                        play(){
                            setTimeout(this.onended, command.delay)
                        }
                    });
                }
            }

            for(let i = 0; i < chunks.length; i++){
                chunks[i].onended = () => {;
                    if(i+1 < chunks.length){
                        chunks[i+1].play();
                    }else{
                        console.log("END");
                    }
                }
            }
        }
        var pulse;
        const protocolPrefix = (window.location.protocol === 'https:') ? 'wss:' : 'ws:';
        function createSocket() {
            const socket = new WebSocket(protocolPrefix + '//' + location.host);
            socket.onopen = function(){
                console.log("open!");
            }
            socket.onmessage = (message) => {
                console.log(message.data)
                const data = JSON.parse(message.data);
                if(data.commands && data.bank){
                    speak(data);
                }
            }
            socket.onclose = () => {
                createSocket();
            }
            const send = (obj) => {
                if(socket &&  socket.readyState === socket.OPEN){
                    socket.send(JSON.stringify(obj));
                }
            }
            if(pulse){
                clearInterval(pulse);
            }
            pulse = setInterval(
                () => {
                    try{
                        send({ pulse: 1 });
                    }catch(e){
                        console.warn(e);
                    }
                }, 
            10000);
        }
        createSocket();
    </script>
</html>