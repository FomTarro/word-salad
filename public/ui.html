<!DOCTYPE html>
<html>
    <link rel="stylesheet" type="text/css" href='/css/style.css'>
    <body class="flex column">
        <h2>Word Salad v0.1</h2>
        <hr>
        <div class="flex column">
            <div>
                <div>
                    <label class="bold" for="port">Port</label>
                </div>
                <input class="globalSetting" id="port" type="number" min="3000" max="9999" value="8095">
            </div>
            <div>
                <div>
                    <label class="bold" for="source">Browser Source URL</label>
                </div>
                <input id="source" name="source" type="text" readonly>
            </div>
            <div>
                <form onSubmit="return false;">
                    <div>
                        <label class="bold" for="speak">Say A Phrase...</label>
                    </div>
                    <input id="speak" name="speak" type="text"> <button id="speakButton">Speak!</button>
                </form>
            </div>
            <div>
                <div>
                    <label class="bold" for="wordBankSelection">Word Banks</label>
                </div>
                <div class="flex row">
                    <select id="wordBankSelection">
                        <option value="Default">Default</option>
                    </select>
                    <button id="createButton">New Word Bank</button>
                </div>
            </div>
            <hr>
            <div class="contentTab flex column" id="mainTab">
                <div class="bankModule flex column">
                    <div>
                        <input class="bankName bankSetting" id="name" type="text">
                        <button>Delete Word Bank</button>
                    </div>
                    <div>
                        <div>
                            <label class="bold" for="delay">Punctuation Pause Duration</label>
                        </div>
                        <input class="globalSetting" id="delay" type="number" min="1" max="1000" value="500"> <span class="italic">milliseconds</span>
                    </div>
                </div>
            </div>
            <!-- <div class="contentTab flex" id="wordListTab">
                <div>
                    <div>
                        <label class="bold" for="wordDirectorySelect">Default</label>
                    </div>    
                    <button id="wordDirectorySelect">Select Word Directory</button> <span id="wordDirectoryDisplay" class="overflowHidden">...</span>
                </div>
                <div>
                    <label class="bold" for="wordList">Word List</label> <button id="wordRefresh">Refresh List</button>
                </div>
                <ul id="wordList">
                
                </ul>
            </div> -->
        </div>
    </body>
    <script>
        const DEFAULT_BANK = "Default";
        
        document.getElementById('source').value = `http://${window.location.host}/speaker`;
        
        const speakInput = document.getElementById('speak');
        
        document.getElementById('speakButton').addEventListener('click', async () => {
            console.log(`Saying: ${speakInput.value}`);
            const response = await fetch(`/speak?bank=${DEFAULT_BANK}&phrase=${speakInput.value}`, {
                method: "GET",
            });
        });

        document.getElementById('createButton').addEventListener('click', async () => {
            const response = await fetch("/save/bank", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    name: "NEW!"
                })
            });
        });

        async function getWordListForBank(bank) {
            const settings = await fetch(`/banks/${bank}/words`, {
                method: "GET",
            });
            const body = await settings.json();
            const list = document.getElementById("wordList");
            list.innerHTML = "";
            for(const word of body){
                const li = document.createElement("li");
                li.innerHTML = word;
                list.append(li);
                li.addEventListener('click', () => {
                    speakInput.value = `${speakInput.value} ${word}`.trim();
                })
            }
        }

        // document.getElementById("wordRefresh").addEventListener('click', async () => {
        //     getWordListForBank(DEFAULT_BANK);
        // });

        async function load(){
            const response = await fetch(`/load`, {
                method: "GET",
            });
            const settings = await response.json()
            for(const property in settings){
                console.log(`${property} : ${settings[property]}`);
                const elem = document.getElementById(property);
                if(elem){
                    elem.value = settings[property];
                }
            }
            for(const bank of settings.banks){
                console.log(bank);
                // create new HTML element using the name/UUID/path found here
            }
        }
        
        async function saveGlobalSetting(key, value){
            const data = {
                [key] : value
            };
            const response = await fetch("/save/general", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data)
            });
            if(key === "port"){
                window.location.href = `http://localhost:${value}/`
            }
            load();
        }
        
        for(const setting of document.getElementsByClassName('globalSetting')){
            setting.addEventListener("change", async () => {
                await saveGlobalSetting(setting.id, setting.value);
            });
        }

        async function saveBankSetting(name, key, value){
            const data = {
                name: name,
                [key]: value,
            };
            const response = await fetch("/save/bank", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(data)
            });
            getWordListForBank(name);
        }

        // document.getElementById("wordDirectorySelect").addEventListener('click', async () => {
        //     const dir = await window.electronAPI.selectDirectory();
        //     if(dir){
        //         document.getElementById("wordDirectoryDisplay").innerHTML = dir;
        //         await saveBankSetting(DEFAULT_BANK, 'path', dir);
        //     }
        // })

        function openTab(tabName){
            const tabs = document.getElementsByClassName('contentTab');
            for(const tab of tabs){
                if(tab.id !== tabName){
                    tab.classList.add('hidden')
                }else{
                    tab.classList.remove('hidden');
                }
            }
        }
        
        for(const button of document.getElementsByClassName('tabButton')){
            button.addEventListener("click", async () => {
                openTab(button.getAttribute('target'));
            });
        }

        load();
        getWordListForBank(DEFAULT_BANK);
        openTab('mainTab');
    </script>
</html>