<!DOCTYPE html>
<html>
    <link rel="stylesheet" type="text/css" href='/css/style.css'>
    <body class="flex">
        <h2>Word Salad v0.1</h2>
        <nav>
            <button class="tabButton" target="mainTab">General</button>
            <button class="tabButton" target="wordListTab">Word List</button>
        </nav>
        <hr>
        <div class="flex">
            <div>
                <div>
                    <label class="bold" for="source">Browser Source URL</label>
                </div>
                <input id="source" name="source" type="text" readonly>
            </div>
            <div>
                <form onSubmit="return false;">
                    <div>
                        <label class="bold" for="speak">Say A Phrase...</label>
                    </div>
                    <input id="speak" name="speak" type="text"> <button id="speakButton">Speak!</button>
                </form>
            </div>
            <hr>
            <div class="contentTab flex" id="mainTab">
            <!-- LOL? -->
                <div>
                    <div>
                        <label class="bold" for="port">Port</label>
                    </div>
                    <input class="generalSetting" id="port" type="number" min="3000" max="9999" value="8095">
                </div>
                <div>
                    <div>
                        <label class="bold" for="delay">Punctuation Pause Duration</label>
                    </div>
                    <input class="generalSetting" id="delay" type="number" min="1" max="1000" value="500"> <span class="italic">milliseconds</span>
                </div>
            </div>
            <!--  -->
            <div class="contentTab flex" id="wordListTab">
                <div>
                    <div>
                        <label class="bold" for="wordDirectorySelect">Default</label>
                    </div>    
                    <button id="wordDirectorySelect">Select Word Directory</button> <span id="wordDirectoryDisplay" class="overflowHidden">...</span>
                </div>
                <div>
                    <label class="bold" for="wordList">Word List</label> <button id="wordRefresh">Refresh List</button>
                </div>
                <ul id="wordList">
                    <!-- Words go here -->
                </ul>
            </div>
        </div>
    </body>
    <script>
        const DEFAULT_BANK = "Default";
        document.getElementById("wordDirectorySelect").addEventListener('click', async () => {
            const dir = await window.electronAPI.selectDirectory();
            if(dir){
                document.getElementById("wordDirectoryDisplay").innerHTML = dir;
                console.log(dir);
                const data = {
                    name: DEFAULT_BANK,
                    path: dir,
                };
                const response = await fetch("/save/bank", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data)
                });
                getWordListForBank(DEFAULT_BANK);
            }
        })
        document.getElementById('source').value = `http://${window.location.host}/speaker`;
        const speakInput = document.getElementById('speak');
        document.getElementById('speakButton').addEventListener('click', async () => {
            console.log(`Saying: ${speakInput.value}`);
            const response = await fetch(`/speak?bank=${DEFAULT_BANK}&phrase=${speakInput.value}`, {
                method: "GET",
            });
        });

        async function getWordListForBank(bank) {
            const settings = await fetch(`/banks/${bank}/words`, {
                method: "GET",
            });
            const body = await settings.json();
            const list = document.getElementById("wordList");
            list.innerHTML = "";
            for(const word of body){
                const li = document.createElement("li");
                li.innerHTML = word;
                list.append(li);
                li.addEventListener('click', () => {
                    speakInput.value = `${speakInput.value} ${word}`.trim();
                })
            }
        }
        document.getElementById("wordRefresh").addEventListener('click', async () => {
            getWordListForBank(DEFAULT_BANK);
        })
        getWordListForBank(DEFAULT_BANK);

        async function load(){
            const settings = await fetch(`/load`, {
                method: "GET",
            });
            const body = await settings.json()
            for(const property in body){
                console.log(`${property} : ${body[property]}`);
                const elem = document.getElementById(property);
                if(elem){
                    elem.value = body[property];
                }
            }
        }
        load();
        for(const setting of document.getElementsByClassName('generalSetting')){
            setting.addEventListener("change", async () => {
                const data = {
                    [setting.id] : setting.value
                };
                const response = await fetch("/save/general", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data)
                });
                if(setting.id === "port"){
                    window.location.href = `http://localhost:${setting.value}/`
                }
                load();
            });
        }

        function openTab(tabName){
            const tabs = document.getElementsByClassName('contentTab');
            for(const tab of tabs){
                if(tab.id !== tabName){
                    tab.classList.add('hidden')
                }else{
                    tab.classList.remove('hidden');
                }
            }
        }
        
        for(const button of document.getElementsByClassName('tabButton')){
            button.addEventListener("click", async () => {
                openTab(button.getAttribute('target'));
            });
        }
        openTab('mainTab');
    </script>
</html>