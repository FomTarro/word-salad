<!DOCTYPE html>
<html>
    <script>
        function speak(commands) {
            const chunks = []
            const ready = [];
            for(const command of commands){
                console.log(command);
                if(command.path){
                    const clip = new Audio(`./words/${command.path}`);
                    clip.oncanplaythrough = () => {
                        ready.push(true);
                        if(ready.length == chunks.length){
                            chunks[0].play();
                        }
                    }
                    chunks.push({
                        onended: undefined,
                        play(){
                            clip.onended = this.onended;
                            clip.play();
                        }   
                    });
                }else{
                    ready.push(true);
                    chunks.push({
                        onended: undefined,
                        play(){
                            setTimeout(() => {
                                this.onended();
                            }, command.delay)
                        }
                    });
                }
            }

            for(let i = 0; i < chunks.length; i++){

                chunks[i].onended = () => {;
                    if(i+1 < chunks.length){
                        chunks[i+1].play();
                    }else{
                        console.log("END");
                    }
                }
            }
        }
        var pulse;
        var protocolPrefix = (window.location.protocol === 'https:') ? 'wss:' : 'ws:';
        function createSocket() {
            const socket = new WebSocket(protocolPrefix + '//' + location.host);
            socket.onopen = function(){
                console.log("open!");
            }
            socket.onmessage = function(message){
                console.log(message.data)
                const data = JSON.parse(message.data);
                if(data.files){
                    speak(data.files);
                }
            }
            socket.onclose = function(){
                createSocket();
            }
            function send(obj){
                if(socket &&  socket.readyState === socket.OPEN){
                    socket.send(JSON.stringify(obj));
                }
            }
            if(pulse){
                clearInterval(pulse);
            }
            pulse = setInterval(
                function(){
                    try{
                        send(
                            {pulse: 1}
                        );
                    }catch(e){

                    }
                }, 
            10000);
        }
        createSocket();
    </script>
</html>